@page "/admin/ospravedlnenky"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Excuses
@using ZISK.Shared.Enums
@inject IExcusesApi ExcusesApi
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin,Coach")]

<PageTitle>Správa ospravedlneniek</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Správa ospravedlneniek</MudText>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_error != null)
{
    <MudAlert Severity="Severity.Error">@_error</MudAlert>
}
else
{
    <MudTable Items="@_excuses" Hover="true">
        <HeaderContent>
            <MudTh>Dieťa</MudTh>
            <MudTh>Tím</MudTh>
            <MudTh>Dátum</MudTh>
            <MudTh>Dôvod</MudTh>
            <MudTh>Stav</MudTh>
            <MudTh>Akcie</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.ChildName</MudTd>
            <MudTd>@context.TeamName</MudTd>
            <MudTd>
                @if (context.DateFrom.HasValue)
                {
                    @context.DateFrom.Value.ToString("dd.MM.yyyy")
                }
            </MudTd>
            <MudTd>@context.Reason</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd>
                @if (context.Status == ExcuseStatus.Pending)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small"
                                   OnClick="@(() => Approve(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => Reject(context.Id))" />
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _isLoading = true;
    private string? _error;
    private List<ExcuseListDto> _excuses = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadExcuses();
    }

    private async Task LoadExcuses()
    {
        try
        {
            _isLoading = true;
            _excuses = await ExcusesApi.GetExcusesAsync(null);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task Approve(Guid id)
    {
        try
        {
            await ExcusesApi.UpdateStatusAsync(id, new UpdateExcuseStatusRequest(ExcuseStatus.Approved, null));
            Snackbar.Add("Schválené", Severity.Success);
            await LoadExcuses();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task Reject(Guid id)
    {
        try
        {
            await ExcusesApi.UpdateStatusAsync(id, new UpdateExcuseStatusRequest(ExcuseStatus.Rejected, null));
            Snackbar.Add("Zamietnuté", Severity.Warning);
            await LoadExcuses();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(ExcuseStatus status) => status switch
    {
        ExcuseStatus.Approved => Color.Success,
        ExcuseStatus.Pending => Color.Warning,
        ExcuseStatus.Rejected => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(ExcuseStatus status) => status switch
    {
        ExcuseStatus.Approved => "Schválené",
        ExcuseStatus.Pending => "Čaká",
        ExcuseStatus.Rejected => "Zamietnuté",
        _ => "?"
    };
}