@page "/oznamy"
@using ZISK.Client.Pages.SampleData

<PageTitle>Oznamy</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Oznamy</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="8" md="6">
            <MudTextField @bind-Value="_searchText" Placeholder="Hľadať v oznamoch..." Variant="Variant.Outlined"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="4" md="3">
            <MudSelect T="string" @bind-Value="_selectedTeam" Label="Tím" Variant="Variant.Outlined">
                <MudSelectItem Value="@("all")">Všetky tímy</MudSelectItem>
                <MudSelectItem Value="@("A-tím")">A-tím</MudSelectItem>
                <MudSelectItem Value="@("B-tím")">B-tím</MudSelectItem>
                <MudSelectItem Value="@("Žiaci")">Žiaci</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="12" md="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       Href="/oznamy/vytvorit" FullWidth="true">
                Nový oznam
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudStack Spacing="3">
    @foreach (var announcement in GetFilteredAnnouncements())
    {
        <MudPaper Class="pa-4" Elevation="@(announcement.IsPinned ? 4 : 2)"
                  Style="@(announcement.IsPinned ? "border-left: 4px solid var(--mud-palette-primary);" : "")">
            <MudStack Spacing="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                    <MudStack Spacing="1" Style="flex: 1;">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            @if (announcement.IsPinned)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.PushPin" Size="Size.Small" Color="Color.Primary" />
                            }
                            <MudText Typo="Typo.h6">@announcement.Title</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                @announcement.AuthorName
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" />
                                @GetRelativeTime(announcement.CreatedAt)
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                                @announcement.ViewCount
                            </MudText>
                        </MudStack>
                    </MudStack>
                    <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(announcement.Priority)" Variant="Variant.Filled">
                        @announcement.Priority
                    </MudChip>
                </MudStack>

                <MudDivider />

                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@announcement.Content</MudText>

                <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="1">
                        <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Group" Color="Color.Default">
                            @announcement.Team
                        </MudChip>
                        @if (announcement.UpdatedAt.HasValue)
                        {
                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" Color="Color.Secondary">
                                Upravené
                            </MudChip>
                        }
                    </MudStack>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" Color="Color.Primary" />
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Color="Color.Default"
                                       OnClick="@(() => OpenAnnouncementMenu(announcement))" />
                    </MudStack>
                </MudStack>
            </MudStack>
        </MudPaper>
    }
</MudStack>

@if (!GetFilteredAnnouncements().Any())
{
    <MudPaper Class="pa-6 text-center" Elevation="0">
        <MudIcon Icon="@Icons.Material.Filled.Announcement" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">Žiadne oznamy</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @if (!string.IsNullOrWhiteSpace(_searchText))
            {
                <span>Skúste zmeniť vyhľadávací výraz</span>
            }
            else
            {
                <span>Zatiaľ neboli zverejnené žiadne oznamy</span>
            }
        </MudText>
    </MudPaper>
}

@code {
    private string _searchText = string.Empty;
    private string _selectedTeam = "all";

    private List<AnnouncementsSampleData.Announcement> GetAnnouncements()
    {
        return AnnouncementsSampleData.GetAnnouncements();
    }

    private List<AnnouncementsSampleData.Announcement> GetFilteredAnnouncements()
    {
        var announcements = GetAnnouncements();

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            announcements = announcements.Where(a =>
                a.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                a.Content.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        if (_selectedTeam != "all")
        {
            announcements = announcements.Where(a => a.Team == _selectedTeam || a.Team == "Všetky").ToList();
        }

        return announcements
            .OrderByDescending(a => a.IsPinned)
            .ThenByDescending(a => a.CreatedAt)
            .ToList();
    }

    private Color GetPriorityColor(string priority)
    {
        return priority switch
        {
            "Vysoká" => Color.Error,
            "Stredná" => Color.Warning,
            "Nízka" => Color.Info,
            _ => Color.Default
        };
    }

    private string GetRelativeTime(DateTime date)
    {
        var span = DateTime.Now - date;

        if (span.TotalMinutes < 60)
            return $"pred {(int)span.TotalMinutes} min";
        if (span.TotalHours < 24)
            return $"pred {(int)span.TotalHours} hod";
        if (span.TotalDays < 7)
            return $"pred {(int)span.TotalDays} dňami";

        return date.ToString("dd.MM.yyyy");
    }

    private void OpenAnnouncementMenu(AnnouncementsSampleData.Announcement announcement)
    {
        // TODO
    }
}