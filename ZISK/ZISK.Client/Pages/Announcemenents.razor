@page "/oznamy"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Announcements
@using ZISK.Shared.Enums
@inject IAnnouncementsApi AnnouncementsApi
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Oznamy</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Oznamy</MudText>
    <AuthorizeView Roles="Admin,Coach">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/oznamy/vytvorit">
            Nový oznam
        </MudButton>
    </AuthorizeView>
</MudStack>

@* Filter *@
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="4">
            <MudSelect T="AnnouncementPriority?" @bind-Value="_filterPriority" Label="Priorita" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem T="AnnouncementPriority?" Value="@(AnnouncementPriority.High)">Vysoká</MudSelectItem>
                <MudSelectItem T="AnnouncementPriority?" Value="@(AnnouncementPriority.Medium)">Stredná</MudSelectItem>
                <MudSelectItem T="AnnouncementPriority?" Value="@(AnnouncementPriority.Low)">Nízka</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="4" Class="d-flex align-end">
            <MudButton Variant="Variant.Outlined" OnClick="LoadAnnouncements">Filtrovať</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (!_announcements.Any())
{
    <MudPaper Class="pa-6" Elevation="1">
        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
            Zatiaľ neboli zverejnené žiadne oznamy
        </MudText>
    </MudPaper>
}
else
{
    <MudStack Spacing="3">
        @foreach (var announcement in _announcements)
        {
            <MudPaper Class="pa-4" Elevation="2" Style="@GetAnnouncementStyle(announcement)">
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                        <MudStack Spacing="0">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                @if (announcement.IsPinned)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.PushPin" Size="Size.Small" Color="Color.Primary" />
                                }
                                <MudText Typo="Typo.h6">@announcement.Title</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @announcement.AuthorName • @announcement.PublishDate.ToString("dd.MM.yyyy HH:mm")
                                @if (!string.IsNullOrEmpty(announcement.TargetTeamName))
                                {
                                    <text> • @announcement.TargetTeamName</text>
                                }
                            </MudText>
                        </MudStack>
                        <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(announcement.Priority)">
                            @GetPriorityText(announcement.Priority)
                        </MudChip>
                    </MudStack>

                    <MudDivider />

                    <MudText Typo="Typo.body1">@announcement.ContentPreview</MudText>

                    @if (announcement.AttachmentCount > 0)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" />
                            @announcement.AttachmentCount prílohy
                        </MudText>
                    }

                    @if (announcement.ValidUntil.HasValue)
                    {
                        <MudText Typo="Typo.caption" Color="@(announcement.ValidUntil.Value < DateTime.Now ? Color.Error : Color.Secondary)">
                            Platí do: @announcement.ValidUntil.Value.ToString("dd.MM.yyyy")
                        </MudText>
                    }
                </MudStack>
            </MudPaper>
        }
    </MudStack>
}

@code {
    private bool _isLoading = true;
    private List<AnnouncementListDto> _announcements = new();
    private AnnouncementPriority? _filterPriority;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnnouncements();
    }

    private async Task LoadAnnouncements()
    {
        try
        {
            _isLoading = true;
            _announcements = await AnnouncementsApi.GetAnnouncementsAsync(null, null);
            
            if (_filterPriority.HasValue)
            {
                _announcements = _announcements.Where(a => a.Priority == _filterPriority.Value).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetAnnouncementStyle(AnnouncementListDto announcement)
    {
        var borderColor = announcement.Priority switch
        {
            AnnouncementPriority.High => "#f44336",
            AnnouncementPriority.Medium => "#ff9800",
            _ => "#1976d2"
        };
        return $"border-left: 4px solid {borderColor};";
    }

    private Color GetPriorityColor(AnnouncementPriority priority) => priority switch
    {
        AnnouncementPriority.High => Color.Error,
        AnnouncementPriority.Medium => Color.Warning,
        AnnouncementPriority.Low => Color.Info,
        _ => Color.Default
    };

    private string GetPriorityText(AnnouncementPriority priority) => priority switch
    {
        AnnouncementPriority.High => "Dôležité",
        AnnouncementPriority.Medium => "Stredná",
        AnnouncementPriority.Low => "Informačné",
        _ => "?"
    };
}