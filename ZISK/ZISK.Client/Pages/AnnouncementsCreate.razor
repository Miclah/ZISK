@page "/oznamy/vytvorit"
@using ZISK.Client.Pages.SampleData
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Vytvoriť oznam</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Vytvoriť nový oznam</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudForm @ref="_form" @bind-IsValid="_formIsValid">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_announcement.Title" Label="Nadpis oznamu" Variant="Variant.Outlined"
                                  Required="true" RequiredError="Nadpis je povinný"
                                  Counter="100" MaxLength="100"
                                  HelperText="Stručný a výstižný nadpis" />

                    <MudTextField @bind-Value="_announcement.Content" Label="Obsah oznamu" Lines="8" Variant="Variant.Outlined"
                                  Required="true" RequiredError="Obsah je povinný"
                                  Counter="500" MaxLength="500"
                                  HelperText="Detailný popis oznamu" />

                    <MudSelect @bind-Value="_announcement.Team" Label="Určené pre tím" Variant="Variant.Outlined"
                               Required="true" HelperText="Ktorému tímu je oznam určený">
                        <MudSelectItem Value="@("Všetky")">
                            <div style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" Class="mr-2" />
                                <span>Všetky tímy</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("A-tím")">A-tím</MudSelectItem>
                        <MudSelectItem Value="@("B-tím")">B-tím</MudSelectItem>
                        <MudSelectItem Value="@("Žiaci")">Žiaci</MudSelectItem>
                    </MudSelect>

                    <MudSelect @bind-Value="_announcement.Priority" Label="Priorita" Variant="Variant.Outlined"
                               Required="true" HelperText="Dôležitosť oznamu">
                        <MudSelectItem Value="@("Nízka")">
                            <div style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Small" Class="mr-2" />
                                <span>Nízka (informačné)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("Stredná")">
                            <div style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                                <span>Stredná (dôležité)</span>
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("Vysoká")">
                            <div style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" Class="mr-2" />
                                <span>Vysoká (urgentné)</span>
                            </div>
                        </MudSelectItem>
                    </MudSelect>

                    <MudCheckBox @bind-Value="_announcement.PinToTop" Label="Pripnúť hore (zobrazí sa na začiatku feedu)"
                                 Color="Color.Primary" />
                </MudStack>
            </MudForm>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="0">
            <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween">
                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel"
                           StartIcon="@Icons.Material.Filled.ArrowBack">
                    Zrušiť
                </MudButton>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="@(!_formIsValid)"
                               StartIcon="@Icons.Material.Filled.Visibility" OnClick="@(() => _showPreview = !_showPreview)">
                        @(_showPreview ? "Skryť náhľad" : "Zobraziť náhľad")
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Send"
                               Disabled="@(!_formIsValid)" OnClick="Publish">
                        Zverejniť
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        @if (_showPreview)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Náhľad</MudText>
                <MudDivider Class="mb-3" />

                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                        <MudStack Spacing="1" Style="flex: 1;">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                @if (_announcement.PinToTop)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.PushPin" Size="Size.Small" Color="Color.Primary" />
                                }
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(_announcement.Title ?? "Nadpis")</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Ján Novák • práve teraz
                            </MudText>
                        </MudStack>
                        <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(_announcement.Priority)" Variant="Variant.Filled">
                            @_announcement.Priority
                        </MudChip>
                    </MudStack>

                    <MudDivider />

                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                        @(_announcement.Content ?? "Obsah oznamu...")
                    </MudText>

                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Group" Color="Color.Default">
                        @_announcement.Team
                    </MudChip>
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Large" Color="Color.Secondary" />
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="mt-2">
                    Kliknite na "Zobraziť náhľad" pre zobrazenie ako bude oznam vyzerať
                </MudText>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    private MudForm? _form;
    private bool _formIsValid;
    private bool _showPreview = false;

    private class AnnouncementForm
    {
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string Team { get; set; } = "Všetky";
        public string Priority { get; set; } = "Stredná";
        public bool PinToTop { get; set; } = false;
    }

    private AnnouncementForm _announcement = new();

    private void Cancel()
    {
        NavigationManager.NavigateTo("/oznamy");
    }

    private void Publish()
    {
        // TODO
        Snackbar.Add("Oznam úspešne zverejnený!", Severity.Success);
        NavigationManager.NavigateTo("/oznamy");
    }

    private Color GetPriorityColor(string priority)
    {
        return priority switch
        {
            "Vysoká" => Color.Error,
            "Stredná" => Color.Warning,
            "Nízka" => Color.Info,
            _ => Color.Default
        };
    }
}