@page "/oznamy/vytvorit"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Announcements
@using ZISK.Shared.DTOs.Teams
@using ZISK.Shared.Enums
@inject IAnnouncementsApi AnnouncementsApi
@inject ITeamsApi TeamsApi
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject HttpClient Http
@attribute [Authorize(Roles = "Admin,Coach")]

<PageTitle>Nový oznam</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Nový oznam</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_title" Label="Nadpis oznamu" Variant="Variant.Outlined" 
                              Required="true" RequiredError="Nadpis je povinný" />

                <MudTextField @bind-Value="_content" Label="Obsah oznamu" Variant="Variant.Outlined" 
                              Lines="6" Required="true" RequiredError="Obsah je povinný" />

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="Guid?" @bind-Value="_targetTeamId" Label="Určené pre tím" Variant="Variant.Outlined" Clearable="true">
                            @foreach (var team in _teams)
                            {
                                <MudSelectItem Value="@((Guid?)team.Id)">@team.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Prázdne = pre všetky tímy</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="TargetAudience" @bind-Value="_targetAudience" Label="Cieľová skupina" Variant="Variant.Outlined">
                            <MudSelectItem Value="TargetAudience.All">Všetci</MudSelectItem>
                            <MudSelectItem Value="TargetAudience.Parents">Rodičia</MudSelectItem>
                            <MudSelectItem Value="TargetAudience.Athletes">Športovci</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="AnnouncementPriority" @bind-Value="_priority" Label="Priorita" Variant="Variant.Outlined">
                            <MudSelectItem Value="AnnouncementPriority.Low">Nízka (informačné)</MudSelectItem>
                            <MudSelectItem Value="AnnouncementPriority.Medium">Stredná (dôležité)</MudSelectItem>
                            <MudSelectItem Value="AnnouncementPriority.High">Vysoká (urgentné)</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudDatePicker @bind-Date="_validUntil" Label="Platí do (voliteľné)" Variant="Variant.Outlined" 
                                       MinDate="DateTime.Now" Clearable="true" />
                    </MudItem>
                </MudGrid>

                <MudCheckBox @bind-Value="_isPinned" Label="Pripnúť na začiatok" Color="Color.Primary" />

                <MudDivider Class="my-2" />

                // AI
                <MudText Typo="Typo.subtitle1">Prílohy (voliteľné)</MudText>
                
                <MudFileUpload T="IReadOnlyList<IBrowserFile>" 
                               FilesChanged="OnFilesSelected"
                               Accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif"
                               MaximumFileCount="5">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.CloudUpload">
                            Vybrať súbory
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Podporované formáty: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF (max 10MB)
                </MudText>

                @if (_selectedFiles.Any())
                {
                    <MudStack Spacing="1">
                        @foreach (var file in _selectedFiles)
                        {
                            <MudPaper Class="pa-2" Elevation="0" Style="background-color: #f5f5f5;">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@GetFileIcon(file.Name)" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Typo="Typo.body2">@file.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">(@FormatFileSize(file.Size))</MudText>
                                    </MudStack>
                                    <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" 
                                                   OnClick="@(() => RemoveFile(file))" />
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
            </MudStack>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="0">
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                <MudButton Variant="Variant.Text" OnClick="Cancel">Zrušiť</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" 
                           Disabled="@(!CanSubmit() || _isSubmitting)">
                    @if (_isSubmitting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Zverejniť
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool _isSubmitting = false;
    private List<TeamDto> _teams = new();
    private List<IBrowserFile> _selectedFiles = new();

    private string _title = "";
    private string _content = "";
    private Guid? _targetTeamId;
    private TargetAudience _targetAudience = TargetAudience.All;
    private AnnouncementPriority _priority = AnnouncementPriority.Medium;
    private bool _isPinned = false;
    private DateTime? _validUntil;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _teams = await TeamsApi.GetTeamsAsync(true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba pri načítaní tímov: {ex.Message}", Severity.Error);
        }
    }

    private bool CanSubmit()
    {
        return !string.IsNullOrWhiteSpace(_title) && !string.IsNullOrWhiteSpace(_content);
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/oznamy");
    }

    private void OnFilesSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (file.Size > 10 * 1024 * 1024)
            {
                Snackbar.Add($"Súbor {file.Name} je príliš veľký (max 10MB)", Severity.Warning);
                continue;
            }

            if (!_selectedFiles.Any(f => f.Name == file.Name))
            {
                _selectedFiles.Add(file);
            }
        }
    }

    private void RemoveFile(IBrowserFile file)
    {
        _selectedFiles.Remove(file);
    }

    private string GetFileIcon(string fileName)
    {
        var ext = Path.GetExtension(fileName).ToLowerInvariant();
        return ext switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".doc" or ".docx" => Icons.Material.Filled.Description,
            ".xls" or ".xlsx" => Icons.Material.Filled.TableChart,
            ".jpg" or ".jpeg" or ".png" or ".gif" => Icons.Material.Filled.Image,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    // AI
    private async Task Submit()
    {
        if (!CanSubmit()) return;

        _isSubmitting = true;

        try
        {
            var request = new CreateAnnouncementRequest(
                Title: _title,
                Content: _content,
                TargetTeamId: _targetTeamId,
                TargetAudience: _targetAudience,
                Priority: _priority,
                IsPinned: _isPinned,
                ValidUntil: _validUntil
            );

            var announcement = await AnnouncementsApi.CreateAnnouncementAsync(request);

            if (_selectedFiles.Any())
            {
                foreach (var file in _selectedFiles)
                {
                    try
                    {
                        using var content = new MultipartFormDataContent();
                        using var fileStream = file.OpenReadStream(10 * 1024 * 1024);
                        using var memoryStream = new MemoryStream();
                        await fileStream.CopyToAsync(memoryStream);
                        memoryStream.Position = 0;
                        
                        var fileContent = new ByteArrayContent(memoryStream.ToArray());
                        fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(
                            file.ContentType ?? "application/octet-stream");
                        content.Add(fileContent, "file", file.Name);

                        var response = await Http.PostAsync($"/api/announcements/{announcement.Id}/attachments", content);
                        if (!response.IsSuccessStatusCode)
                        {
                            Snackbar.Add($"Nepodarilo sa nahrať súbor {file.Name}", Severity.Warning);
                        }
                    }
                    catch (Exception ex)
                    {
                        Snackbar.Add($"Chyba pri nahrávaní {file.Name}: {ex.Message}", Severity.Warning);
                    }
                }
            }

            Snackbar.Add("Oznam bol zverejnený", Severity.Success);
            NavigationManager.NavigateTo("/oznamy");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}