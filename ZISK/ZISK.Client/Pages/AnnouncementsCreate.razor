@page "/oznamy/vytvorit"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Announcements
@using ZISK.Shared.DTOs.Teams
@using ZISK.Shared.Enums
@inject IAnnouncementsApi AnnouncementsApi
@inject ITeamsApi TeamsApi
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin,Coach")]

<PageTitle>Nový oznam</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Nový oznam</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_title" Label="Nadpis oznamu" Variant="Variant.Outlined" 
                              Required="true" RequiredError="Nadpis je povinný" />

                <MudTextField @bind-Value="_content" Label="Obsah oznamu" Variant="Variant.Outlined" 
                              Lines="6" Required="true" RequiredError="Obsah je povinný" />

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="Guid?" @bind-Value="_targetTeamId" Label="Určené pre tím" Variant="Variant.Outlined" Clearable="true">
                            @foreach (var team in _teams)
                            {
                                <MudSelectItem Value="@((Guid?)team.Id)">@team.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Prázdne = pre všetky tímy</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="TargetAudience" @bind-Value="_targetAudience" Label="Cieľová skupina" Variant="Variant.Outlined">
                            <MudSelectItem Value="TargetAudience.All">Všetci</MudSelectItem>
                            <MudSelectItem Value="TargetAudience.Parents">Rodičia</MudSelectItem>
                            <MudSelectItem Value="TargetAudience.Athletes">Športovci</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudSelect T="AnnouncementPriority" @bind-Value="_priority" Label="Priorita" Variant="Variant.Outlined">
                            <MudSelectItem Value="AnnouncementPriority.Low">Nízka (informačné)</MudSelectItem>
                            <MudSelectItem Value="AnnouncementPriority.Medium">Stredná (dôležité)</MudSelectItem>
                            <MudSelectItem Value="AnnouncementPriority.High">Vysoká (urgentné)</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudDatePicker @bind-Date="_validUntil" Label="Platí do (voliteľné)" Variant="Variant.Outlined" 
                                       MinDate="DateTime.Now" Clearable="true" />
                    </MudItem>
                </MudGrid>

                <MudCheckBox @bind-Value="_isPinned" Label="Pripnúť na začiatok" Color="Color.Primary" />
            </MudStack>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="0">
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                <MudButton Variant="Variant.Text" OnClick="Cancel">Zrušiť</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" 
                           Disabled="@(!CanSubmit() || _isSubmitting)">
                    @if (_isSubmitting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Zverejniť
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="1">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Tipy</MudText>
            <MudList T="string" Dense="true">
                <MudListItem>Vysoká priorita - pre urgentné správy (zrušený tréning)</MudListItem>
                <MudListItem>Stredná priorita - pre dôležité informácie</MudListItem>
                <MudListItem>Nízka priorita - pre bežné oznamy</MudListItem>
            </MudList>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool _isSubmitting = false;
    private List<TeamDto> _teams = new();

    private string _title = "";
    private string _content = "";
    private Guid? _targetTeamId;
    private TargetAudience _targetAudience = TargetAudience.All;
    private AnnouncementPriority _priority = AnnouncementPriority.Medium;
    private bool _isPinned = false;
    private DateTime? _validUntil;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _teams = await TeamsApi.GetTeamsAsync(true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba pri načítaní tímov: {ex.Message}", Severity.Error);
        }
    }

    private bool CanSubmit()
    {
        return !string.IsNullOrWhiteSpace(_title) && !string.IsNullOrWhiteSpace(_content);
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/oznamy");
    }

    private async Task Submit()
    {
        if (!CanSubmit()) return;

        _isSubmitting = true;

        try
        {
            var request = new CreateAnnouncementRequest(
                Title: _title,
                Content: _content,
                TargetTeamId: _targetTeamId,
                TargetAudience: _targetAudience,
                Priority: _priority,
                IsPinned: _isPinned,
                ValidUntil: _validUntil
            );

            await AnnouncementsApi.CreateAnnouncementAsync(request);
            Snackbar.Add("Oznam bol zverejnený", Severity.Success);
            NavigationManager.NavigateTo("/oznamy");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}