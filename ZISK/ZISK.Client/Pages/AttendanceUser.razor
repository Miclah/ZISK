@page "/dochadzka/prehlad"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Attendance
@using ZISK.Shared.Enums
@inject IAttendanceApi AttendanceApi
@inject IExcusesApi ExcusesApi
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Moja dochádzka</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Prehľad dochádzky</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker @bind-Date="_dateFrom" Label="Od dátumu" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDatePicker @bind-Date="_dateTo" Label="Do dátumu" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadAttendance">
                Zobraziť
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudGrid Class="mb-4">
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1">
            <MudText Typo="Typo.h4" Color="Color.Success">@GetCount(AttendanceStatus.Present)</MudText>
            <MudText Typo="Typo.body2">Prítomný</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1">
            <MudText Typo="Typo.h4" Color="Color.Error">@GetCount(AttendanceStatus.Absent)</MudText>
            <MudText Typo="Typo.body2">Neprítomný</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1">
            <MudText Typo="Typo.h4" Color="Color.Warning">@GetCount(AttendanceStatus.Late)</MudText>
            <MudText Typo="Typo.body2">Meškanie</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3" Elevation="1">
            <MudText Typo="Typo.h4" Color="Color.Info">@GetCount(AttendanceStatus.Excused)</MudText>
            <MudText Typo="Typo.body2">Ospravedlnený</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (!_attendance.Any())
{
    <MudPaper Class="pa-6" Elevation="1">
        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
            Žiadne záznamy o dochádzke za vybrané obdobie
        </MudText>
    </MudPaper>
}
else
{
    <MudPaper Class="pa-4" Elevation="2">
        <MudTable Items="@_attendance" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Dátum</MudTh>
                <MudTh>Tréning</MudTh>
                <MudTh>Stav</MudTh>
                <MudTh>Poznámka trénera</MudTh>
                <MudTh>Akcia</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Dátum">
                    <MudText Typo="Typo.body2">@context.Date.ToString("dd.MM.yyyy")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @context.Date.ToString("dddd", new System.Globalization.CultureInfo("sk-SK"))
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Tréning">@context.TrainingName</MudTd>
                <MudTd DataLabel="Stav">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @GetStatusText(context.Status)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Poznámka">
                    @if (!string.IsNullOrEmpty(context.Note))
                    {
                        <MudText Typo="Typo.body2">@context.Note</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Akcia">
                    @if (context.Status == AttendanceStatus.Absent)
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                   OnClick="@(() => NavigateToExcuse())">
                            Podať ospravedlnenku
                        </MudButton>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}

@code {
    private bool _isLoading = true;
    private List<UserAttendanceDto> _attendance = new();
    private DateTime? _dateFrom = DateTime.Now.AddDays(-30);
    private DateTime? _dateTo = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadAttendance();
    }

    private async Task LoadAttendance()
    {
        try
        {
            _isLoading = true;
            _attendance = await AttendanceApi.GetMyAttendanceAsync(_dateFrom, _dateTo);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private int GetCount(AttendanceStatus status)
    {
        return _attendance.Count(a => a.Status == status);
    }

    private void NavigateToExcuse()
    {
        NavigationManager.NavigateTo("/ospravedlnenky/vytvorit");
    }

    private Color GetStatusColor(AttendanceStatus status) => status switch
    {
        AttendanceStatus.Present => Color.Success,
        AttendanceStatus.Absent => Color.Error,
        AttendanceStatus.Late => Color.Warning,
        AttendanceStatus.Excused => Color.Info,
        _ => Color.Default
    };

    private string GetStatusText(AttendanceStatus status) => status switch
    {
        AttendanceStatus.Present => "Prítomný",
        AttendanceStatus.Absent => "Neprítomný",
        AttendanceStatus.Late => "Meškanie",
        AttendanceStatus.Excused => "Ospravedlnený",
        _ => "Neznámy"
    };
}