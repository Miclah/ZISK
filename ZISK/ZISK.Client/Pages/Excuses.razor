@page "/ospravedlnenky"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Excuses
@using ZISK.Shared.Enums
@inject IExcusesApi ExcusesApi
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Ospravedlnenky</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Ospravedlnenky</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/ospravedlnenky/vytvorit">
        Nová ospravedlnenka
    </MudButton>
</MudStack>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_error != null)
{
    <MudAlert Severity="Severity.Error">@_error</MudAlert>
}
else if (!_excuses.Any())
{
    <MudAlert Severity="Severity.Info">Žiadne ospravedlnenky</MudAlert>
}
else
{
    <MudTable Items="@_excuses" Hover="true">
        <HeaderContent>
            <MudTh>Dieťa</MudTh>
            <MudTh>Dátum</MudTh>
            <MudTh>Dôvod</MudTh>
            <MudTh>Stav</MudTh>
            <MudTh>Akcie</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.ChildName</MudTd>
            <MudTd>
                @if (context.DateFrom.HasValue)
                {
                    @context.DateFrom.Value.ToString("dd.MM.yyyy")
                }
            </MudTd>
            <MudTd>@context.Reason</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd>
                @if (context.Status == ExcuseStatus.Pending)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                   Href="@($"/ospravedlnenky/upravit/{context.Id}")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => DeleteExcuse(context.Id))" />
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _isLoading = true;
    private string? _error;
    private List<ExcuseListDto> _excuses = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadExcuses();
    }

    private async Task LoadExcuses()
    {
        try
        {
            _isLoading = true;
            _excuses = await ExcusesApi.GetMyExcusesAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task DeleteExcuse(Guid id)
    {
        try
        {
            await ExcusesApi.DeleteExcuseAsync(id);
            Snackbar.Add("Ospravedlnenka vymazaná", Severity.Success);
            await LoadExcuses();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(ExcuseStatus status) => status switch
    {
        ExcuseStatus.Approved => Color.Success,
        ExcuseStatus.Pending => Color.Warning,
        ExcuseStatus.Rejected => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(ExcuseStatus status) => status switch
    {
        ExcuseStatus.Approved => "Schválené",
        ExcuseStatus.Pending => "Čaká",
        ExcuseStatus.Rejected => "Zamietnuté",
        _ => "?"
    };
}