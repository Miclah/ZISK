@page "/ospravedlnenky"
@using ZISK.Client.Pages.SampleData

<PageTitle>Ospravedlnenky</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Ospravedlnenky</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="6">
            <MudSelect T="string" @bind-Value="_selectedStatus" Label="Filter podľa stavu" Variant="Variant.Outlined">
                <MudSelectItem Value="@("all")">Všetky</MudSelectItem>
                <MudSelectItem Value="@("Čaká na schválenie")">Čaká na schválenie</MudSelectItem>
                <MudSelectItem Value="@("Schválené")">Schválené</MudSelectItem>
                <MudSelectItem Value="@("Zamietnuté")">Zamietnuté</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="6" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       FullWidth="true" OnClick="@(() => {})">
                Vytvoriť novú
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudTable Items="@GetFilteredExcuses()" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="3">
    <HeaderContent>
        <MudTh>Dátum</MudTh>
        <MudTh>Dôvod</MudTh>
        <MudTh>Stav</MudTh>
        <MudTh>Komentár trénera</MudTh>
        <MudTh Style="text-align: right;">Akcie</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Dátum">
            <MudText Typo="Typo.body2">@context.Date.ToString("dd.MM.yyyy")</MudText>
            @if (context.DateTo.HasValue)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">do @context.DateTo.Value.ToString("dd.MM.yyyy")</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Dôvod">
            <MudText Typo="Typo.body2">@context.Reason</MudText>
            @if (!string.IsNullOrEmpty(context.Note))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Note</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Stav">
            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)" Variant="Variant.Filled">
                @context.Status
            </MudChip>
        </MudTd>
        <MudTd DataLabel="Komentár">
            <MudText Typo="Typo.body2" Color="Color.Secondary">@(context.CoachComment ?? "-")</MudText>
        </MudTd>
        <MudTd DataLabel="Akcie" Style="text-align: right;">
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" Size="Size.Small"
                           OnClick="@(() => ViewExcuseDetail(context))" />
            @if (context.Status == "Čaká na schválenie")
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Secondary" Size="Size.Small" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" />
            }
        </MudTd>
    </RowTemplate>
</MudTable>

<MudDialog @bind-IsVisible="_showDetailDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Detail ospravedlnenky</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedExcuse != null)
        {
            <MudStack Spacing="3">
                <MudText Typo="Typo.body1">
                    <strong>Dátum:</strong> @_selectedExcuse.Date.ToString("dd.MM.yyyy")
                    @if (_selectedExcuse.DateTo.HasValue)
                    {
                        <span> - @_selectedExcuse.DateTo.Value.ToString("dd.MM.yyyy")</span>
                    }
                </MudText>
                <MudText Typo="Typo.body1"><strong>Dôvod:</strong> @_selectedExcuse.Reason</MudText>
                <MudText Typo="Typo.body1"><strong>Poznámka:</strong> @(_selectedExcuse.Note ?? "-")</MudText>
                <MudText Typo="Typo.body1">
                    <strong>Stav:</strong>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_selectedExcuse.Status)">
                        @_selectedExcuse.Status
                    </MudChip>
                </MudText>
                @if (!string.IsNullOrEmpty(_selectedExcuse.CoachComment))
                {
                    <MudDivider />
                    <MudText Typo="Typo.body1"><strong>Komentár trénera:</strong></MudText>
                    <MudAlert Severity="Severity.Info">@_selectedExcuse.CoachComment</MudAlert>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _showDetailDialog = false)">
            Zavrieť
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private string _selectedStatus = "all";
    private bool _showDetailDialog = false;
    private ExcusesSampleData.Excuse? _selectedExcuse = null;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Medium, FullWidth = true };

    private List<ExcusesSampleData.Excuse> GetExcuses()
    {
        return ExcusesSampleData.GetExcuses();
    }

    private List<ExcusesSampleData.Excuse> GetFilteredExcuses()
    {
        var excuses = GetExcuses();

        if (_selectedStatus != "all")
            excuses = excuses.Where(e => e.Status == _selectedStatus).ToList();

        return excuses.OrderByDescending(e => e.Date).ToList();
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Schválené" => Color.Success,
            "Čaká na schválenie" => Color.Warning,
            "Zamietnuté" => Color.Error,
            _ => Color.Default
        };
    }

    private void ViewExcuseDetail(ExcusesSampleData.Excuse excuse)
    {
        _selectedExcuse = excuse;
        _showDetailDialog = true;
    }
}