@page "/rozvrh"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Teams
@using ZISK.Shared.DTOs.Trainings
@using ZISK.Shared.Enums
@inject ITeamsApi TeamsApi
@inject ITrainingsApi TrainingsApi
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Rozvrh tréningov</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Rozvrh tréningov</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudSelect T="Guid?" @bind-Value="_selectedTeamId" @bind-Value:after="LoadTrainings"
               Label="Tím" Variant="Variant.Outlined">
        <MudSelectItem Value="@((Guid?)null)">Všetky tímy</MudSelectItem>
        @foreach (var team in _teams)
        {
            <MudSelectItem Value="@((Guid?)team.Id)">@team.Name</MudSelectItem>
        }
    </MudSelect>
</MudPaper>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (!_trainings.Any())
{
    <MudAlert Severity="Severity.Info">Žiadne tréningy</MudAlert>
}
else
{
    <MudTable Items="@_trainings" Hover="true">
        <HeaderContent>
            <MudTh>Dátum</MudTh>
            <MudTh>Názov</MudTh>
            <MudTh>Tím</MudTh>
            <MudTh>Typ</MudTh>
            <MudTh>Miesto</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.StartTime.ToString("dd.MM.yyyy HH:mm")</MudTd>
            <MudTd>@context.Title</MudTd>
            <MudTd>@context.TeamName</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(context.Type)">
                    @GetTypeText(context.Type)
                </MudChip>
            </MudTd>
            <MudTd>@(context.Location ?? "-")</MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _isLoading = true;
    private List<TeamDto> _teams = new();
    private List<TrainingEventDto> _trainings = new();
    private Guid? _selectedTeamId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _teams = await TeamsApi.GetTeamsAsync(true);
            await LoadTrainings();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadTrainings()
    {
        try
        {
            _isLoading = true;
            _trainings = await TrainingsApi.GetTrainingsAsync(_selectedTeamId, null, null);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetTypeColor(TrainingType type) => type switch
    {
        TrainingType.Conditioning => Color.Primary,
        TrainingType.Technical => Color.Secondary,
        TrainingType.Match => Color.Tertiary,
        _ => Color.Default
    };

    private string GetTypeText(TrainingType type) => type switch
    {
        TrainingType.Conditioning => "Kondičný",
        TrainingType.Technical => "Technický",
        TrainingType.Match => "Herný",
        TrainingType.Recovery => "Regeneračný",
        _ => "Iný"
    };
}