@page "/dochadzka"
@using ZISK.Client.Services
@using ZISK.Shared.DTOs.Teams
@using ZISK.Shared.DTOs.Trainings
@using ZISK.Shared.DTOs.Attendance
@using ZISK.Shared.Enums
@inject ITeamsApi TeamsApi
@inject ITrainingsApi TrainingsApi
@inject IAttendanceApi AttendanceApi
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin,Coach")]

<PageTitle>Dochádzka</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Označenie dochádzky</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid?" @bind-Value="_selectedTeamId" @bind-Value:after="LoadTrainings"
                       Label="Tím" Variant="Variant.Outlined">
                @foreach (var team in _teams)
                {
                    <MudSelectItem Value="@((Guid?)team.Id)">@team.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudSelect T="Guid?" @bind-Value="_selectedTrainingId" @bind-Value:after="LoadAttendance"
                       Label="Tréning" Variant="Variant.Outlined" Disabled="@(_selectedTeamId == null)">
                @foreach (var training in _trainings)
                {
                    <MudSelectItem Value="@((Guid?)training.Id)">
                        @training.StartTime.ToString("dd.MM.yyyy HH:mm") - @training.Title
                    </MudSelectItem>
                }
            </MudSelect>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_selectedTraining != null)
{
    <MudTable Items="@_selectedTraining.Attendance" Hover="true">
        <HeaderContent>
            <MudTh>Meno</MudTh>
            <MudTh>Stav</MudTh>
            <MudTh>Akcie</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.ChildName</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                    @GetStatusText(context.Status)
                </MudChip>
            </MudTd>
            <MudTd>
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                    <MudButton Color="Color.Success" OnClick="@(() => MarkStatus(context.ChildId, AttendanceStatus.Present))">P</MudButton>
                    <MudButton Color="Color.Error" OnClick="@(() => MarkStatus(context.ChildId, AttendanceStatus.Absent))">N</MudButton>
                    <MudButton Color="Color.Warning" OnClick="@(() => MarkStatus(context.ChildId, AttendanceStatus.Late))">M</MudButton>
                    <MudButton Color="Color.Info" OnClick="@(() => MarkStatus(context.ChildId, AttendanceStatus.Excused))">O</MudButton>
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <MudAlert Severity="Severity.Info">Vyberte tím a tréning</MudAlert>
}

@code {
    private bool _isLoading = false;
    private List<TeamDto> _teams = new();
    private List<TrainingEventDto> _trainings = new();
    private TrainingEventDetailDto? _selectedTraining;
    
    private Guid? _selectedTeamId;
    private Guid? _selectedTrainingId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _teams = await TeamsApi.GetTeamsAsync(true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadTrainings()
    {
        _trainings = new();
        _selectedTrainingId = null;
        _selectedTraining = null;
        
        if (_selectedTeamId == null) return;

        try
        {
            _trainings = await TrainingsApi.GetTrainingsAsync(_selectedTeamId, null, null);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAttendance()
    {
        _selectedTraining = null;
        if (_selectedTrainingId == null) return;

        try
        {
            _isLoading = true;
            _selectedTraining = await TrainingsApi.GetTrainingAsync(_selectedTrainingId.Value);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task MarkStatus(Guid childId, AttendanceStatus status)
    {
        if (_selectedTrainingId == null) return;

        try
        {
            await AttendanceApi.MarkAttendanceAsync(new MarkAttendanceRequest(
                _selectedTrainingId.Value,
                childId,
                status,
                null,
                null
            ));
            Snackbar.Add("Uložené", Severity.Success);
            await LoadAttendance();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(AttendanceStatus status) => status switch
    {
        AttendanceStatus.Present => Color.Success,
        AttendanceStatus.Absent => Color.Error,
        AttendanceStatus.Late => Color.Warning,
        AttendanceStatus.Excused => Color.Info,
        _ => Color.Default
    };

    private string GetStatusText(AttendanceStatus status) => status switch
    {
        AttendanceStatus.Present => "Prítomný",
        AttendanceStatus.Absent => "Neprítomný",
        AttendanceStatus.Late => "Meškanie",
        AttendanceStatus.Excused => "Ospravedlnený",
        _ => "?"
    };
}